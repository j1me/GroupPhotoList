<!DOCTYPE html>
<html>
<head>
    <title>FaceFrame - Results</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js"></script>
    <style>
        .gradient-bg { background: linear-gradient(180deg, #EBF4FF 0%, #F3E8FF 100%); }
        .face-name-input {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
        }
        .disco-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
        .gif-menu {
            z-index: 50;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: opacity 0.2s ease-in-out;
        }
        .gif-menu button {
            transition: background-color 0.2s ease-in-out;
        }
        .gif-menu button:hover {
            background-color: rgba(139, 92, 246, 0.1);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="p-4 sm:p-6 lg:p-8 flex flex-col min-h-screen">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-flex items-center justify-center flex-col">
                <a href="index.html" class="text-4xl font-bold text-blue-800 hover:text-blue-900 transition-colors">FaceFrame</a>
                <p class="mt-2 text-gray-600">Privacy-first face detection</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div class="bg-white rounded-lg shadow-lg max-w-4xl mx-auto p-6">
                <!-- Upload Another Image Button -->
                <div class="text-center mb-8">
                    <a href="index.html" class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Upload Another Image
                    </a>
                </div>

                <!-- Results Area -->
                <div id="results">
                    <div class="flex flex-col md:flex-row gap-6 mb-8">
                        <!-- Left side: Original photo -->
                        <div class="md:w-1/2">
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Original Photo</h2>
                            <div class="relative group">
                                <!-- Main carousel -->
                                <div class="relative">
                                    <div id="main-carousel" class="relative overflow-hidden rounded-lg shadow-md">
                                        <div class="flex transition-transform duration-300">
                                            <img id="original-image" class="w-full shrink-0" src="" alt="Original photo">
                                            <img id="dance-preview-gif" class="w-full shrink-0 hidden" src="" alt="Dance Party Preview">
                                        </div>
                                        <!-- Carousel controls -->
                                        <div class="absolute inset-0 flex items-center justify-between p-4">
                                            <button id="main-prev" class="p-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all transform -translate-x-2 opacity-0 group-hover:opacity-100 group-hover:translate-x-0">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                                </svg>
                                            </button>
                                            <button id="main-next" class="p-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all transform translate-x-2 opacity-0 group-hover:opacity-100 group-hover:translate-x-0">
                                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <!-- Expand button -->
                                        <button onclick="expandView('main-carousel')" class="absolute top-4 right-4 p-2 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all transform scale-90 opacity-0 group-hover:opacity-100 group-hover:scale-100">
                                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <!-- Carousel indicators -->
                                    <div class="absolute -bottom-6 left-0 right-0 flex justify-center gap-2">
                                        <button class="w-2 h-2 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors" onclick="showMainSlide(0)"></button>
                                        <button class="w-2 h-2 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors" onclick="showMainSlide(1)"></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right side: Info and buttons -->
                        <div class="md:w-1/2">
                            <div class="bg-white p-6 rounded-lg shadow-md">
                                <div id="face-count-info" class="mb-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Detection Results</h3>
                                    <p class="text-gray-600">Processing your photo...</p>
                                </div>

                                <div class="space-y-4">
                                    <button onclick="generatePDF()" class="w-full bg-purple-500 hover:bg-purple-600 text-white text-sm font-semibold py-3 px-4 rounded transition duration-300 flex items-center justify-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        Generate PDF List
                                    </button>

                                    <button id="dance-party-btn" onclick="generateDanceParty()" class="w-full bg-pink-500 hover:bg-pink-600 text-white text-sm font-semibold py-3 px-4 rounded transition duration-300 flex items-center justify-center">
                                        <span class="mr-2">ðŸ’ƒ</span>
                                        Generate Dance Party
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Detected Faces</h2>
                    <div id="faces-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>

                    <div id="disco-section" class="mt-8 hidden">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Disco Mode</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="disco-grid"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="mt-8 text-center">
            <a href="about.html" class="text-blue-600 hover:text-blue-800 font-medium">About FaceFrame</a>
        </footer>
    </div>

    <!-- Modal for expanded view -->
    <div id="expanded-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden flex items-center justify-center">
        <div class="max-w-4xl w-full mx-4 relative">
            <!-- Close button - moved outside carousel for better visibility -->
            <button onclick="closeExpandedView()" class="absolute -top-12 right-0 p-2 bg-white text-black rounded-full hover:bg-gray-200 transition-all z-50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="relative">
                <div id="expanded-carousel" class="relative overflow-hidden rounded-lg">
                    <div class="flex transition-transform duration-300">
                        <!-- Content will be cloned here -->
                    </div>
                    <!-- Expanded view controls -->
                    <div class="absolute inset-0 flex items-center justify-between p-4">
                        <button id="expanded-prev" class="p-3 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button id="expanded-next" class="p-3 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Expanded view indicators -->
                <div class="absolute -bottom-8 left-0 right-0 flex justify-center gap-2">
                    <button class="w-2.5 h-2.5 rounded-full bg-gray-400 hover:bg-gray-300 transition-colors" onclick="showExpandedSlide(0)"></button>
                    <button class="w-2.5 h-2.5 rounded-full bg-gray-400 hover:bg-gray-300 transition-colors" onclick="showExpandedSlide(1)"></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to create face card
        function createFaceCard(faceData, index) {
            const faceElement = document.createElement('div');
            faceElement.className = 'bg-white p-4 rounded-lg shadow-md';
            
            // Create carousel container
            const carouselContainer = document.createElement('div');
            carouselContainer.className = 'relative group mb-3';
            carouselContainer.innerHTML = `
                <div id="face-carousel-${index}" class="relative overflow-hidden rounded">
                    <div class="flex transition-transform duration-300">
                        <div class="w-full h-48 shrink-0">
                            <img src="${faceData}" class="w-full h-48 object-cover" alt="Face ${index + 1}" data-face-index="${index}">
                        </div>
                        <div class="w-full h-48 shrink-0 hidden" id="face-gif-container-${index}">
                            <!-- GIF will be added here -->
                        </div>
                    </div>
                    <!-- Carousel controls -->
                    <div class="absolute inset-0 flex items-center justify-between p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="showFaceSlide(${index}, 0)" class="p-1 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all transform -translate-x-2 group-hover:translate-x-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <button onclick="showFaceSlide(${index}, 1)" class="p-1 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all transform translate-x-2 group-hover:translate-x-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>
                    <!-- Expand button -->
                    <button onclick="expandView('face-carousel-${index}')" class="absolute top-2 right-2 p-1 bg-black bg-opacity-50 text-white rounded-full hover:bg-opacity-75 transition-all transform scale-90 opacity-0 group-hover:opacity-100 group-hover:scale-100">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-5V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                        </svg>
                    </button>
                    <!-- Indicators -->
                    <div class="absolute -bottom-1 left-0 right-0 flex justify-center gap-1">
                        <button class="w-1.5 h-1.5 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors" onclick="showFaceSlide(${index}, 0)"></button>
                        <button class="w-1.5 h-1.5 rounded-full bg-gray-300 hover:bg-gray-400 transition-colors" onclick="showFaceSlide(${index}, 1)"></button>
                    </div>
                </div>
            `;
            
            // Create name input
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.placeholder = `Name for Face ${index + 1}`;
            nameInput.className = 'face-name-input mb-2';
            nameInput.dataset.faceIndex = index;

            // Create button container with icons
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex justify-between items-center mt-2 px-2';

            // Download button
            const downloadButton = document.createElement('button');
            downloadButton.className = 'text-blue-500 hover:text-blue-600 transition-colors';
            downloadButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
            `;
            downloadButton.title = 'Download Face';
            downloadButton.onclick = () => {
                const link = document.createElement('a');
                link.download = `face-${index + 1}.png`;
                link.href = faceData;
                link.click();
            };

            // Google Search button
            const googleSearchButton = document.createElement('button');
            googleSearchButton.className = 'text-green-500 hover:text-green-600 transition-colors';
            googleSearchButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            `;
            googleSearchButton.title = 'Search with Google';
            googleSearchButton.onclick = (e) => {
                e.preventDefault();
                const searchUrl = `https://www.google.com/searchbyimage?image_url=${encodeURIComponent(faceData)}`;
                window.open(searchUrl, '_blank');
            };

            // GIF Generation button with dropdown
            const gifContainer = document.createElement('div');
            gifContainer.className = 'relative';

            const gifButton = document.createElement('button');
            gifButton.className = 'text-purple-500 hover:text-purple-600 transition-colors';
            gifButton.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            `;
            gifButton.title = 'Generate GIF';

            const gifMenu = document.createElement('div');
            gifMenu.className = 'absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 bg-white rounded-lg shadow-lg py-1 hidden w-48';
            gifMenu.innerHTML = `
                <button class="w-full px-4 py-2 text-left hover:bg-purple-50 text-sm" onclick="generateDiscoGif('${faceData}', ${index})">
                    ðŸ•º Disco Effect
                </button>
                <button class="w-full px-4 py-2 text-left hover:bg-purple-50 text-sm" onclick="generateBouncingGif('${faceData}', ${index})">
                    âš¡ Bouncing Effect
                </button>
                <button class="w-full px-4 py-2 text-left hover:bg-purple-50 text-sm" onclick="generateSpinningGif('${faceData}', ${index})">
                    ðŸŒ€ Spinning Effect
                </button>
                <button class="w-full px-4 py-2 text-left hover:bg-purple-50 text-sm" onclick="generateBritneyDance('${faceData}', ${index})">
                    ðŸ’ƒ Dance Like Britney
                </button>
            `;

            gifButton.onclick = () => {
                // Toggle menu
                const allMenus = document.querySelectorAll('.gif-menu');
                allMenus.forEach(menu => {
                    if (menu !== gifMenu) menu.classList.add('hidden');
                });
                gifMenu.classList.toggle('hidden');
            };

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!gifContainer.contains(e.target)) {
                    gifMenu.classList.add('hidden');
                }
            });

            gifMenu.classList.add('gif-menu');
            gifContainer.appendChild(gifButton);
            gifContainer.appendChild(gifMenu);

            buttonContainer.appendChild(downloadButton);
            buttonContainer.appendChild(googleSearchButton);
            buttonContainer.appendChild(gifContainer);

            faceElement.appendChild(carouselContainer);
            faceElement.appendChild(nameInput);
            faceElement.appendChild(buttonContainer);
            return faceElement;
        }

        // Function to generate PDF
        async function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const faces = document.querySelectorAll('.face-name-input');
            
            doc.setFontSize(20);
            doc.text('Face List', 20, 20);
            
            let y = 40;
            const imageSize = 40; // Size of face images in the PDF
            const nameX = 70; // X position for names
            const imagesPerPage = 5;
            let currentPage = 1;

            for (let i = 0; i < faces.length; i++) {
                if (i > 0 && i % imagesPerPage === 0) {
                    doc.addPage();
                    y = 40;
                    currentPage++;
                }

                const input = faces[i];
                const name = input.value || '';
                const faceImg = input.parentElement.parentElement.querySelector('img');
                
                // Convert the face image to base64
                const canvas = document.createElement('canvas');
                canvas.width = imageSize;
                canvas.height = imageSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(faceImg, 0, 0, imageSize, imageSize);
                const imgData = canvas.toDataURL('image/jpeg', 0.8);

                // Add face image
                doc.addImage(imgData, 'JPEG', 20, y - 10, imageSize, imageSize);
                
                // Add name
                doc.setFontSize(12);
                doc.text(name, nameX, y + 10);
                
                // Add line separator
                doc.setDrawColor(200);
                doc.line(20, y + imageSize - 5, 180, y + imageSize - 5);
                
                y += imageSize + 10; // Move down for next entry
            }
            
            doc.save('face-list.pdf');
        }

        // Add new GIF generation functions
        async function generateBouncingGif(faceData, index) {
            try {
                // Create loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'text-center p-4';
                loadingDiv.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">Generating bouncing effect...</p>
                `;
                document.getElementById('disco-grid').appendChild(loadingDiv);

                const frames = [];
                const frameCount = 10;
                
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = faceData;
                });

                for (let i = 0; i < frameCount; i++) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 200;
                    canvas.height = 200;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Calculate bounce position
                    const bounce = Math.abs(Math.sin(i * Math.PI / frameCount)) * 30;
                    
                    // Draw image with bounce effect
                    ctx.drawImage(img, 0, bounce, 200, 200 - bounce);
                    
                    frames.push(canvas.toDataURL());
                }

                createAnimationPreview(frames, index, loadingDiv, 'Bouncing');
            } catch (error) {
                console.error('Error generating bouncing effect:', error);
                alert('Error generating bouncing effect. Please try again.');
            }
        }

        async function generateSpinningGif(faceData, index) {
            try {
                // Create loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'text-center p-4';
                loadingDiv.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">Generating spinning effect...</p>
                `;
                document.getElementById('disco-grid').appendChild(loadingDiv);

                const frames = [];
                const frameCount = 10;
                
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = faceData;
                });

                for (let i = 0; i < frameCount; i++) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 200;
                    canvas.height = 200;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.save();
                    
                    // Center and rotate
                    ctx.translate(100, 100);
                    ctx.rotate((i * Math.PI * 2) / frameCount);
                    ctx.translate(-100, -100);
                    
                    // Draw image
                    ctx.drawImage(img, 0, 0, 200, 200);
                    
                    ctx.restore();
                    frames.push(canvas.toDataURL());
                }

                createAnimationPreview(frames, index, loadingDiv, 'Spinning');
            } catch (error) {
                console.error('Error generating spinning effect:', error);
                alert('Error generating spinning effect. Please try again.');
            }
        }

        // Helper function to create animation preview
        function createAnimationPreview(frames, index, loadingDiv, effectName) {
            const gif = new GIF({
                workers: 2,
                quality: 10,
                width: 200,
                height: 200,
                workerScript: 'gif.worker.js'
            });

            frames.forEach(frameData => {
                const img = new Image();
                img.src = frameData;
                gif.addFrame(img, { delay: 100 });
            });

            gif.on('finished', function(blob) {
                if (loadingDiv && loadingDiv.parentNode) {
                    loadingDiv.parentNode.removeChild(loadingDiv);
                }
                updateFaceGifPreview(index, blob);
            });

            gif.render();
        }

        // Update the disco GIF function to use the new helper
        async function generateDiscoGif(faceData, index) {
            try {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'text-center p-4';
                loadingDiv.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">Generating disco effect...</p>
                `;
                document.getElementById('disco-grid').appendChild(loadingDiv);

                const frames = [];
                const frameCount = 10;
                
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = faceData;
                });

                for (let i = 0; i < frameCount; i++) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 200;
                    canvas.height = 200;
                    const ctx = canvas.getContext('2d', { willReadFrequently: true });
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.save();
                    
                    ctx.translate(100, 100);
                    ctx.rotate((i * Math.PI * 2) / frameCount);
                    ctx.translate(-100, -100);
                    
                    ctx.drawImage(img, 0, 0, 200, 200);
                    
                    ctx.globalCompositeOperation = 'source-atop';
                    ctx.fillStyle = `hsla(${i * 36}, 100%, 50%, 0.5)`;
                    ctx.fillRect(0, 0, 200, 200);
                    
                    ctx.restore();
                    frames.push(canvas.toDataURL());
                }

                createAnimationPreview(frames, index, loadingDiv, 'Disco');
            } catch (error) {
                console.error('Error generating disco effect:', error);
                alert('Error generating disco effect. Please try again.');
            }
        }

        // Add Britney dance animation function
        async function generateBritneyDance(faceData, index) {
            try {
                // Create loading indicator
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'text-center p-4';
                loadingDiv.innerHTML = `
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500 mx-auto mb-2"></div>
                    <p class="text-sm text-gray-600">Generating dance animation...</p>
                `;
                document.getElementById('disco-grid').appendChild(loadingDiv);

                const frames = [];
                const frameCount = 20;
                const canvasWidth = 200;
                const canvasHeight = 200;
                
                const img = new Image();
                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = faceData;
                });

                // Define realistic dancer poses
                const dancerPoses = [
                    // Standing pose with arms up
                    `<svg viewBox="0 0 100 200">
                        <path d="M50 30c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm-4 10c0 0-16 4-16 20 0 0 0 20 2 26 2 6 18 14 18 14s16-8 18-14c2-6 2-26 2-26 0-16-16-20-16-20h-8zm-6 80c0 0-10 20-10 40h40c0-20-10-40-10-40h-20z" fill="currentColor"/>
                    </svg>`,
                    // Dance pose with arms out
                    `<svg viewBox="0 0 100 200">
                        <path d="M50 30c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm-4 10c0 0-30 4-30 20 0 0 10 20 12 26 2 6 22 14 22 14s20-8 22-14c2-6 12-26 12-26 0-16-30-20-30-20h-8zm-6 80c0 0-10 20-10 40h40c0-20-10-40-10-40h-20z" fill="currentColor"/>
                    </svg>`,
                    // Dance pose with leg out
                    `<svg viewBox="0 0 100 200">
                        <path d="M50 30c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm-4 10c0 0-16 4-16 20 0 0 0 20 2 26 2 6 18 14 18 14s16-8 18-14c2-6 2-26 2-26 0-16-16-20-16-20h-8zm-16 80c0 0 0 40 10 40h20c10 0 10-40 10-40h-40z" fill="currentColor"/>
                    </svg>`,
                    // Dance pose with arms and leg out
                    `<svg viewBox="0 0 100 200">
                        <path d="M50 30c5.5 0 10-4.5 10-10s-4.5-10-10-10-10 4.5-10 10 4.5 10 10 10zm-4 10c0 0-30 4-30 20 0 0 10 20 12 26 2 6 22 14 22 14s20-8 22-14c2-6 12-26 12-26 0-16-30-20-30-20h-8zm-16 80c0 0 0 40 10 40h20c10 0 10-40 10-40h-40z" fill="currentColor"/>
                    </svg>`
                ];

                // Add more dynamic movement patterns
                function calculateDancerPosition(i, index, total, canvasWidth, canvasHeight) {
                    const spacing = canvasWidth / (total + 1);
                    const x = spacing * (index + 1);
                    const baseY = canvasHeight * 0.6;  // Position dancers lower on the floor
                    
                    // More dynamic movement patterns
                    const time = i * Math.PI / 10;
                    const bounce = Math.sin(time + index) * 20;  // Vertical bounce
                    const sway = Math.sin(time * 0.8 + index * Math.PI / 2) * 15;  // Side-to-side sway
                    const twist = Math.sin(time * 1.2 + index * Math.PI / 3) * 15;  // Twisting motion
                    
                    return {
                        x: x + sway,
                        y: baseY + bounce,
                        rotation: twist,
                        scale: 1 + Math.sin(time * 0.5) * 0.1  // Pulsing size
                    };
                }

                // Update the dance party generation
                async function generateDanceParty() {
                    try {
                        // Debug the faces grid first
                        const facesGrid = document.getElementById('faces-grid');
                        console.log('Faces grid contents:', facesGrid.innerHTML);

                        // More specific selector for face cards
                        const faces = document.querySelectorAll('#faces-grid > div.bg-white');
                        console.log('Number of faces found:', faces.length);
                        
                        if (faces.length === 0) {
                            console.error('No face cards found in the grid');
                            alert('No faces found to create dance party. Please add some faces first.');
                            return;
                        }

                        // Create loading indicator
                        const loadingDiv = document.createElement('div');
                        loadingDiv.className = 'text-center p-4';
                        loadingDiv.innerHTML = `
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500 mx-auto mb-2"></div>
                            <p class="text-sm text-gray-600">Creating dance party...</p>
                        `;
                        document.getElementById('original-image').parentNode.appendChild(loadingDiv);

                        // Load all face images first
                        const faceImages = await Promise.all(Array.from(faces).map((face, idx) => {
                            return new Promise((resolve, reject) => {
                                try {
                                    const img = new Image();
                                    img.onload = () => resolve(img);
                                    img.onerror = (e) => {
                                        console.error(`Image load error for face ${idx}:`, e);
                                        reject(e);
                                    };
                                    
                                    // Find the first image in the card
                                    const faceImg = face.querySelector('img');
                                    
                                    if (!faceImg) {
                                        console.error(`No face image found for face ${idx}. Card contents:`, face.outerHTML);
                                        reject(new Error(`Face image not found in card ${idx}`));
                                        return;
                                    }
                                    
                                    console.log(`Successfully found face image ${idx}:`, faceImg.src);
                                    img.src = faceImg.src;
                                } catch (error) {
                                    console.error(`Error in face image loading for face ${idx}:`, error);
                                    reject(error);
                                }
                            });
                        }));

                        const frames = [];
                        const frameCount = 20;
                        const canvasWidth = 800;
                        const canvasHeight = 600;

                        // Create frames
                        for (let i = 0; i < frameCount; i++) {
                            const canvas = document.createElement('canvas');
                            canvas.width = canvasWidth;
                            canvas.height = canvasHeight;
                            const ctx = canvas.getContext('2d', { willReadFrequently: true });

                            // Draw disco floor
                            const gradient = ctx.createLinearGradient(0, canvasHeight/2, 0, canvasHeight);
                            gradient.addColorStop(0, `hsl(${i * 18}, 70%, 20%)`);
                            gradient.addColorStop(1, `hsl(${i * 18}, 70%, 10%)`);
                            ctx.fillStyle = gradient;
                            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                            // Draw grid lines for disco floor
                            ctx.strokeStyle = `hsla(${i * 18}, 70%, 40%, 0.3)`;
                            ctx.lineWidth = 2;
                            for (let x = 0; x < canvasWidth; x += 50) {
                                ctx.beginPath();
                                ctx.moveTo(x, canvasHeight/2);
                                ctx.lineTo(x + canvasWidth/2, canvasHeight);
                                ctx.stroke();
                            }

                            // Draw disco ball and effects
                            const ballX = canvasWidth/2;
                            const ballY = 80;
                            const ballRadius = 30;

                            // Draw disco ball glow
                            const ballGlow = ctx.createRadialGradient(ballX, ballY, 0, ballX, ballY, ballRadius * 2);
                            ballGlow.addColorStop(0, `hsla(${i * 18}, 70%, 60%, 0.3)`);
                            ballGlow.addColorStop(1, 'transparent');
                            ctx.fillStyle = ballGlow;
                            ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                            // Draw disco ball
                            ctx.beginPath();
                            ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
                            ctx.fillStyle = '#fff';
                            ctx.fill();

                            // Draw light beams
                            for (let beam = 0; beam < 8; beam++) {
                                const angle = (beam * Math.PI / 4) + (i * Math.PI / 10);
                                ctx.beginPath();
                                ctx.moveTo(ballX, ballY);
                                ctx.lineTo(
                                    ballX + Math.cos(angle) * canvasWidth,
                                    ballY + Math.sin(angle) * canvasHeight
                                );
                                ctx.strokeStyle = `hsla(${i * 18 + beam * 45}, 70%, 60%, 0.2)`;
                                ctx.lineWidth = 30;
                                ctx.stroke();
                            }

                            // Draw dancers with faces
                            faceImages.forEach((faceImg, index) => {
                                const pos = calculateDancerPosition(i, index, faceImages.length, canvasWidth, canvasHeight);
                                const dancerPose = dancerPoses[i % dancerPoses.length];
                                
                                // Create dancer with face
                                const dancerCanvas = document.createElement('canvas');
                                dancerCanvas.width = 100;
                                dancerCanvas.height = 200;
                                const dancerCtx = dancerCanvas.getContext('2d');

                                // Draw dancer body with color
                                dancerCtx.fillStyle = `hsl(${index * 360/faceImages.length}, 70%, 50%)`;
                                const parser = new DOMParser();
                                const svgDoc = parser.parseFromString(dancerPose, 'image/svg+xml');
                                const pathData = svgDoc.querySelector('path').getAttribute('d');
                                const path = new Path2D(pathData);
                                dancerCtx.fill(path);

                                // Draw face
                                const faceSize = 40;
                                dancerCtx.drawImage(faceImg, 30, 0, faceSize, faceSize);

                                // Add dancer to main canvas with animation
                                ctx.save();
                                ctx.translate(pos.x, pos.y);
                                ctx.rotate(pos.rotation * Math.PI / 180);
                                ctx.scale(pos.scale, pos.scale);
                                ctx.translate(-50, -100);
                                ctx.drawImage(dancerCanvas, 0, 0);
                                ctx.restore();
                            });

                            frames.push(canvas.toDataURL());
                        }

                        // Create GIF
                        const gif = new GIF({
                            workers: 2,
                            quality: 10,
                            width: canvasWidth,
                            height: canvasHeight,
                            workerScript: 'gif.worker.js'
                        });

                        frames.forEach(frameData => {
                            const img = new Image();
                            img.src = frameData;
                            gif.addFrame(img, { delay: 100 });
                        });

                        gif.on('finished', function(blob) {
                            if (loadingDiv.parentNode) {
                                loadingDiv.parentNode.removeChild(loadingDiv);
                            }
                            updateDancePreview(blob);
                        });

                        gif.render();

                    } catch (error) {
                        console.error('Error generating dance party:', error);
                        alert('Error creating dance party. Please try again.');
                    }
                }

                // Load results when page loads
                window.addEventListener('load', () => {
                    const originalImageData = localStorage.getItem('originalImage');
                    const facesData = JSON.parse(localStorage.getItem('faces') || '[]');
                    
                    if (originalImageData) {
                        document.getElementById('original-image').src = originalImageData;
                    }

                    const facesGrid = document.getElementById('faces-grid');
                    facesData.forEach((faceData, index) => {
                        const faceCard = createFaceCard(faceData, index);
                        facesGrid.appendChild(faceCard);
                    });

                    // Update face count info
                    const faceCountInfo = document.getElementById('face-count-info');
                    const faceCount = facesData.length;
                    faceCountInfo.innerHTML = `
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Detection Results</h3>
                        <p class="text-gray-600">
                            ${faceCount === 0 ? 'No faces detected' : 
                              faceCount === 1 ? '1 face detected' : 
                              `${faceCount} faces detected`} in your photo
                        </p>
                        ${faceCount > 0 ? '<p class="text-sm text-gray-500 mt-2">You can name each face and create a fun dance party animation!</p>' : ''}
                    `;

                    // Clear storage after loading
                    localStorage.removeItem('originalImage');
                    localStorage.removeItem('faces');
                });

                // Update the GIF preview to show above the original image
                function updateDancePreview(gifBlob) {
                    const overlay = document.getElementById('dance-preview-overlay');
                    const previewGif = document.getElementById('dance-preview-gif');
                    const danceButton = document.getElementById('dance-party-btn');
                    
                    previewGif.src = URL.createObjectURL(gifBlob);
                    overlay.classList.remove('hidden');
                    
                    // Update button to download
                    danceButton.innerHTML = `
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download Dance Party GIF
                    `;
                    danceButton.onclick = () => {
                        const link = document.createElement('a');
                        link.href = previewGif.src;
                        link.download = 'dance-party.gif';
                        link.click();
                    };
                }

                // Carousel functionality
                let currentMainSlide = 0;
                const mainCarousel = document.getElementById('main-carousel');
                const mainPrev = document.getElementById('main-prev');
                const mainNext = document.getElementById('main-next');

                function showMainSlide(index) {
                    const carousel = mainCarousel.querySelector('.flex');
                    currentMainSlide = index;
                    carousel.style.transform = `translateX(-${index * 100}%)`;
                    updateMainIndicators();
                }

                function updateMainIndicators() {
                    const indicators = document.querySelectorAll('#main-carousel + div button');
                    indicators.forEach((indicator, index) => {
                        indicator.classList.toggle('bg-blue-500', index === currentMainSlide);
                        indicator.classList.toggle('bg-gray-300', index !== currentMainSlide);
                    });
                }

                mainPrev.onclick = () => showMainSlide(Math.max(0, currentMainSlide - 1));
                mainNext.onclick = () => showMainSlide(Math.min(1, currentMainSlide + 1));

                // Expanded view functionality
                let currentExpandedCarouselId = null;
                
                function expandView(carouselId) {
                    const modal = document.getElementById('expanded-modal');
                    const sourceCarousel = document.getElementById(carouselId);
                    const expandedCarousel = document.getElementById('expanded-carousel');
                    currentExpandedCarouselId = carouselId;
                    
                    // Clone the carousel content
                    const content = sourceCarousel.querySelector('.flex').cloneNode(true);
                    expandedCarousel.querySelector('.flex').replaceWith(content);
                    
                    // Get current slide index
                    const currentSlide = carouselId === 'main-carousel' ? currentMainSlide : 
                                       (currentFaceSlides[carouselId.split('-')[2]] || 0);
                    
                    // Show current slide
                    content.style.transform = `translateX(-${currentSlide * 100}%)`;
                    
                    // Show modal
                    modal.classList.remove('hidden');
                    
                    // Update expanded view controls
                    document.getElementById('expanded-prev').onclick = () => {
                        const isMainCarousel = carouselId === 'main-carousel';
                        const currentIndex = isMainCarousel ? currentMainSlide : 
                                           currentFaceSlides[carouselId.split('-')[2]] || 0;
                        const newIndex = Math.max(0, currentIndex - 1);
                        
                        if (isMainCarousel) {
                            showMainSlide(newIndex);
                        } else {
                            showFaceSlide(carouselId.split('-')[2], newIndex);
                        }
                        content.style.transform = `translateX(-${newIndex * 100}%)`;
                    };
                    
                    document.getElementById('expanded-next').onclick = () => {
                        const isMainCarousel = carouselId === 'main-carousel';
                        const currentIndex = isMainCarousel ? currentMainSlide : 
                                           currentFaceSlides[carouselId.split('-')[2]] || 0;
                        const newIndex = Math.min(1, currentIndex + 1);
                        
                        if (isMainCarousel) {
                            showMainSlide(newIndex);
                        } else {
                            showFaceSlide(carouselId.split('-')[2], newIndex);
                        }
                        content.style.transform = `translateX(-${newIndex * 100}%)`;
                    };

                    // Add keyboard navigation
                    document.addEventListener('keydown', handleExpandedKeyPress);
                }

                function handleExpandedKeyPress(e) {
                    if (!document.getElementById('expanded-modal').classList.contains('hidden')) {
                        if (e.key === 'Escape') {
                            closeExpandedView();
                        } else if (e.key === 'ArrowLeft') {
                            document.getElementById('expanded-prev').click();
                        } else if (e.key === 'ArrowRight') {
                            document.getElementById('expanded-next').click();
                        }
                    }
                }

                function closeExpandedView() {
                    document.getElementById('expanded-modal').classList.add('hidden');
                    document.removeEventListener('keydown', handleExpandedKeyPress);
                    currentExpandedCarouselId = null;
                }

                // Update the individual face GIF preview
                function updateFaceGifPreview(faceIndex, gifBlob) {
                    const container = document.getElementById(`face-gif-container-${faceIndex}`);
                    container.innerHTML = `<img src="${URL.createObjectURL(gifBlob)}" class="w-full h-48 object-cover" alt="Face ${faceIndex + 1} Animation">`;
                    container.classList.remove('hidden');
                    showFaceSlide(faceIndex, 1);
                }

                // Add face carousel functionality
                let currentFaceSlides = {};

                function showFaceSlide(faceIndex, slideIndex) {
                    const carousel = document.querySelector(`#face-carousel-${faceIndex} .flex`);
                    currentFaceSlides[faceIndex] = slideIndex;
                    carousel.style.transform = `translateX(-${slideIndex * 100}%)`;
                    updateFaceIndicators(faceIndex);
                }

                function updateFaceIndicators(faceIndex) {
                    const indicators = document.querySelectorAll(`#face-carousel-${faceIndex} + div button`);
                    const currentSlide = currentFaceSlides[faceIndex] || 0;
                    indicators.forEach((indicator, index) => {
                        indicator.classList.toggle('bg-blue-500', index === currentSlide);
                        indicator.classList.toggle('bg-gray-300', index !== currentSlide);
                    });
                }
            } catch (error) {
                console.error('Error generating dance animation:', error);
                alert('Error generating dance animation. Please try again.');
            }
        }
    </script>
</body>
</html> 