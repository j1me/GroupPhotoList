<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Photo Face Detector</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.js"></script>
    <style>
        .face-container {
            transition: transform 0.2s;
        }
        .face-container:hover {
            transform: scale(1.05);
        }
        #temp-canvas {
            display: none;
        }
        #model-status {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 0.875rem;
            z-index: 50;
        }
        .drop-zone {
            border: 2px dashed #4a90e2;
            transition: all 0.3s ease;
        }
        .drop-zone.dragover {
            background-color: rgba(74, 144, 226, 0.1);
            border-color: #2779bd;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">Group Photo Face Detector</h1>
        
        <!-- Upload Section -->
        <div class="max-w-xl mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2" for="photo-upload">
                    Upload a group photo
                </label>
                <input type="file" 
                       id="photo-upload" 
                       accept="image/*"
                       class="hidden">
                <div class="flex items-center justify-center w-full">
                    <label for="photo-upload" 
                           class="drop-zone w-full flex flex-col items-center px-4 py-6 bg-white rounded-lg tracking-wide cursor-pointer hover:bg-blue-50">
                        <svg class="w-8 h-8 text-blue-500" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                            <path d="M16.88 9.1A4 4 0 0 1 16 17H5a5 5 0 0 1-1-9.9V7a3 3 0 0 1 4.52-2.59A4.98 4.98 0 0 1 17 8c0 .38-.04.74-.12 1.1zM11 11h3l-4-4-4 4h3v3h2v-3z"/>
                        </svg>
                        <span class="mt-2 text-base text-gray-600">Drop your photo here or click to select</span>
                    </label>
                </div>
            </div>
            <div id="loading" class="hidden">
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <span class="ml-2">Processing image...</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <h2 class="text-2xl font-semibold mb-4 text-center text-gray-700">Detected Faces</h2>
            <div id="faces-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Face cards will be inserted here -->
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden max-w-xl mx-auto mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative">
        </div>
    </div>

    <!-- Model Status -->
    <div id="model-status" class="hidden">
        Loading models...
    </div>

    <!-- Hidden canvas for processing -->
    <canvas id="temp-canvas"></canvas>

    <script>
        let isModelLoaded = false;
        const modelStatus = document.getElementById('model-status');
        const dropZone = document.querySelector('.drop-zone');
        const photoUpload = document.getElementById('photo-upload');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const facesGrid = document.getElementById('faces-grid');
        const errorMessage = document.getElementById('error-message');

        // Handle drag and drop events
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processImage(files[0]);
            }
        });

        // Load face-api models
        async function loadModels() {
            try {
                modelStatus.textContent = 'Loading face detection models...';
                modelStatus.classList.remove('hidden');

                // Load models from CDN
                const MODEL_URL = 'https://raw.githubusercontent.com/justadudewhohacks/face-api.js/master/weights/';
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);

                isModelLoaded = true;
                modelStatus.textContent = 'Models loaded successfully!';
                setTimeout(() => {
                    modelStatus.classList.add('hidden');
                }, 2000);
            } catch (error) {
                console.error('Error loading models:', error);
                modelStatus.textContent = 'Failed to load models. Please refresh the page.';
                showError('Failed to load face detection models. Please refresh and try again.');
            }
        }

        // Load models on page load
        window.addEventListener('DOMContentLoaded', loadModels);

        function showError(message) {
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        async function processImage(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file.');
                return;
            }

            if (!isModelLoaded) {
                showError('Face detection models are still loading. Please wait a moment and try again.');
                return;
            }

            // Show loading state
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            errorMessage.classList.add('hidden');
            facesGrid.innerHTML = '';

            try {
                // Create an image element
                const img = await createImageBitmap(file);
                
                // Create a canvas to draw the image
                const canvas = document.getElementById('temp-canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);

                // Detect faces
                const detections = await faceapi.detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks();

                if (!detections || detections.length === 0) {
                    showError('No faces were detected in the image. Please try a different photo.');
                    loading.classList.add('hidden');
                    return;
                }

                // Process each detected face
                for (let i = 0; i < detections.length; i++) {
                    const detection = detections[i];
                    const box = detection.detection.box;
                    
                    // Add padding
                    const padding = {
                        x: box.width * 0.2,
                        y: box.height * 0.2
                    };

                    // Create a new canvas for this face
                    const faceCanvas = document.createElement('canvas');
                    const faceCtx = faceCanvas.getContext('2d');
                    
                    // Set canvas size to include padding
                    faceCanvas.width = box.width + (padding.x * 2);
                    faceCanvas.height = box.height + (padding.y * 2);
                    
                    // Draw the face region to the new canvas
                    faceCtx.drawImage(
                        canvas,
                        Math.max(0, box.x - padding.x),
                        Math.max(0, box.y - padding.y),
                        box.width + (padding.x * 2),
                        box.height + (padding.y * 2),
                        0,
                        0,
                        faceCanvas.width,
                        faceCanvas.height
                    );

                    // Create face card
                    const faceCard = document.createElement('div');
                    faceCard.className = 'face-container bg-white rounded-lg shadow-md p-4';
                    faceCard.innerHTML = `
                        <img src="${faceCanvas.toDataURL('image/jpeg')}" 
                             alt="Detected face" 
                             class="w-full h-48 object-cover rounded-lg mb-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Face ${i + 1}</span>
                            <button onclick="window.open('https://lens.google.com/uploadbyurl?url=${encodeURIComponent(faceCanvas.toDataURL('image/jpeg'))}')" 
                                    class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                                Search
                            </button>
                        </div>
                    `;
                    facesGrid.appendChild(faceCard);
                }

                // Show results
                results.classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
                showError('An error occurred while processing the image. Please try again.');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // Handle file input change
        photoUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processImage(file);
            }
        });
    </script>
</body>
</html>
